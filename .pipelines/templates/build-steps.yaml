steps:
  # 1. Configure node
  - task: UseNode@1
    displayName: "Use Node $(NodeVersion)"
    inputs:
      version: "$(NodeVersion)"

  - task: Cache@2
    displayName: Cache pnpm
    inputs:
      key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
      path: $(pnpm_config_cache)

  - script: |
      corepack enable
    displayName: "Enable corepack"

  - script: |
      pnpm config set store-dir $(pnpm_config_cache)
    displayName: "Setup pnpm"
    env:
      COREPACK_INTEGRITY_KEYS: 0

  - script: pnpm --filter ./packages/itwin/tree-widget install
    displayName: pnpm install

  - script: pnpm -w install
    displayName: pnpm install lage


  # - script: pnpm audit --registry=https://registry.npmjs.org --audit-level=high --production
  #   displayName: Audit

  # - script: pnpm exec prettier . --check
  #   displayName: Check formatting

  - script: pnpm build --grouped --to @itwin/tree-widget-react
    displayName: pnpm build tree widget

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 1

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 2

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 3

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 4

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 5

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 6

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 7

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 8

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 9

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 10

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 11

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 12

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 13

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 14

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 15

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 16

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 17

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 18

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 19

  - script: pnpm exec lage cover --grouped --to @itwin/tree-widget-react
    displayName: Cover 20
